name: Release

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build and Release macOS App
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Show Swift version
        run: swift --version

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Validate version consistency
        run: |
          PLIST_VERSION=$(/usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" Resources/Info.plist)
          TAG_VERSION="${{ steps.version.outputs.version }}"
          if [ "$PLIST_VERSION" != "$TAG_VERSION" ]; then
            echo "Error: Version mismatch!"
            echo "Info.plist version: $PLIST_VERSION"
            echo "Git tag version: $TAG_VERSION"
            exit 1
          fi
          echo "Version validation passed: $PLIST_VERSION"

      - name: Build App Bundle
        run: make build

      - name: Verify build
        run: |
          if [ ! -d ".build/release/Marklip Launcher.app" ]; then
            echo "Error: App Bundle not found!"
            exit 1
          fi

          if [ ! -f ".build/release/Marklip Launcher.app/Contents/MacOS/marklip-launcher" ]; then
            echo "Error: Executable not found!"
            exit 1
          fi

          if [ ! -f ".build/release/Marklip Launcher.app/Contents/Info.plist" ]; then
            echo "Error: Info.plist not found!"
            exit 1
          fi

          echo "Build verification passed"

      - name: Create distributable archive
        run: |
          cd .build/release
          zip -r "Marklip-Launcher-${{ steps.version.outputs.version }}.zip" "Marklip Launcher.app"
          cd ../..
          mv ".build/release/Marklip-Launcher-${{ steps.version.outputs.version }}.zip" .

      - name: Generate SHA256 checksum
        run: |
          shasum -a 256 "Marklip-Launcher-${{ steps.version.outputs.version }}.zip" > "Marklip-Launcher-${{ steps.version.outputs.version }}.zip.sha256"
          cat "Marklip-Launcher-${{ steps.version.outputs.version }}.zip.sha256"

      - name: Generate release notes
        id: release_notes
        run: |
          PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sed -n '2p')

          if [ -z "$PREVIOUS_TAG" ]; then
            NOTES="Initial release"
          else
            NOTES="$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:'- %s (%h)')"
          fi

          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Marklip Launcher v${{ steps.version.outputs.version }}"
          body: ${{ steps.release_notes.outputs.notes }}
          files: |
            Marklip-Launcher-${{ steps.version.outputs.version }}.zip
            Marklip-Launcher-${{ steps.version.outputs.version }}.zip.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew-cask:
    name: Update Homebrew Cask
    needs: build-and-release
    runs-on: macos-latest

    steps:
      - name: Wait for GitHub Release to propagate
        run: sleep 10

      - name: Add Homebrew tap
        run: brew tap dayflower/tap

      - name: Update cask via Homebrew
        uses: Homebrew/actions/bump-packages@master
        with:
          token: ${{ secrets.HOMEBREW_GITHUB_API_TOKEN }}
          casks: dayflower/tap/marklip-launcher
          fork: false
